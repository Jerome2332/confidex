# Render Blueprint
# Deploy with: Connect repo in Render dashboard, it auto-detects this file
# Docs: https://render.com/docs/blueprint-spec

services:
  # ===========================================
  # Backend API + Crank Service
  # ===========================================
  - type: web
    name: confidex-backend
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    region: oregon
    plan: starter
    branch: main
    healthCheckPath: /health/live
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: REDIS_URL
        fromService:
          name: confidex-redis
          type: redis
          property: connectionString
      - key: SOLANA_RPC_URL
        sync: false
      - key: NEXT_PUBLIC_RPC_URL
        sync: false
      - key: CRANK_ENABLED
        value: "true"
      - key: CRANK_USE_REAL_MPC
        value: "true"
      - key: CRANK_POLLING_INTERVAL_MS
        value: "5000"
      - key: CRANK_MAX_CONCURRENT_MATCHES
        value: "5"
      - key: CRANK_ERROR_THRESHOLD
        value: "10"
      - key: CRANK_PAUSE_DURATION_MS
        value: "60000"
      - key: ADMIN_API_KEY
        generateValue: true
      - key: SLACK_WEBHOOK_URL
        sync: false
      - key: SENTRY_DSN
        sync: false
      # WebSocket Streaming
      - key: STREAMING_ENABLED
        value: "true"
      - key: WS_PATH
        value: "/ws"
      # CORS for WebSocket (Vercel frontend)
      - key: FRONTEND_URL
        value: "https://confidex-theta.vercel.app"
      - key: ALLOWED_ORIGINS
        value: "https://confidex-theta.vercel.app,https://www.confidex.xyz,https://confidex.xyz"
    disk:
      name: crank-data
      mountPath: /app/data
      sizeGB: 1

  # ===========================================
  # Redis (Rate Limiting + Caching)
  # ===========================================
  - type: redis
    name: confidex-redis
    region: oregon
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
