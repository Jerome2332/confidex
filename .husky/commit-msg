#!/usr/bin/env sh

# Confidex Commit Message Hook
# Enforces conventional commit message format

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Conventional commit pattern
# Format: type(scope): description
# Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build
pattern="^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\([a-z-]+\))?: .{1,72}"

# Allow merge commits and revert commits
if echo "$commit_msg" | grep -qE "^(Merge|Revert)"; then
    exit 0
fi

# Allow WIP commits during development
if echo "$commit_msg" | grep -qiE "^WIP"; then
    echo "Warning: WIP commit. Don't forget to squash before merging."
    exit 0
fi

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "Invalid commit message format!"
    echo ""
    echo "Expected format: type(scope): description"
    echo ""
    echo "Valid types:"
    echo "  feat     - A new feature"
    echo "  fix      - A bug fix"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style changes (formatting, etc)"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvements"
    echo "  test     - Adding or updating tests"
    echo "  chore    - Maintenance tasks"
    echo "  ci       - CI/CD changes"
    echo "  build    - Build system changes"
    echo ""
    echo "Examples:"
    echo "  feat(frontend): add order book component"
    echo "  fix(backend): resolve crank polling issue"
    echo "  docs: update deployment runbook"
    echo ""
    echo "Your commit message: $commit_msg"
    exit 1
fi

echo "Commit message format valid!"
